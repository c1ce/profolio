<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">

    <script th:inline="javascript">

        $(document).ready(function(){
            $("#searchBtn").on("click",function(e) {
                e.preventDefault();
                page(0);
            });

        });
        function page(page){

            location.href="/company/contact/list/" + page ;
        }
        function getCheckboxValue()  {
            // 선택된 목록 가져오기
            const query = 'input[name="removeValue"]:checked';
            const selectedEls =
                document.querySelectorAll(query);

            // 선택된 목록에서 value 찾기
            let deleteList = [];
            selectedEls.forEach((el) => {
                deleteList.push(el.value);
            });

            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            $.ajax({
                url : "/company/contact/delete",
                type : "POST",
                data : {
                    "deleteList" : deleteList,
                },
                beforeSend: function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                success : function(result){
                    location.href = "/company/contact/list";
                }
            });
        }

    </script>
</th:block>

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
    <style>
        select{
            margin-right:10px;
        }
    </style>
</th:block>

<div layout:fragment="content">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <form>
        <table class="table">
            <thead>
            <tr>
                <td>받는사람</td>
                <td>읽음여부</td>
                <td>내용</td>
                <td>날짜</td>
                <td>삭제</td>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item, status: ${list.getContent()}">
                <td>
                    <a th:href="'/company/contact/'+${item.id}" th:text="${item.recvName}"></a>
                </td>
                <td th:if="${item.conatctStatus.toString().equals('READ')}">읽음</td>
                <td th:unless="${item.conatctStatus.toString().equals('READ')}">안읽음</td>
                <!--                <td th:text="${item.createdBy}"></td>-->
                <td th:if="${#strings.length(item.Text)>=10}" th:text="${#strings.substring(item.Text,0,9)}+'...'"></td>
                <td th:if="${#strings.length(item.Text)<10}" th:text="${item.Text}"></td>

                <td th:text="${#strings.substring(#strings.replace(item.regTime,'T',' '),0,19)}"></td>

                <td><input type="checkbox" name="removeValue" th:value="${item.id}"></td>
            </tr>
            </tbody>
        </table>

        <div th:with="start=${(list.number/maxPage)*maxPage + 1}, end=(${(list.totalPages == 0) ? 1 : (start + (maxPage - 1) < list.totalPages ? start + (maxPage - 1) : list.totalPages)})" >
            <ul class="pagination justify-content-center">

                <li class="page-item" th:classappend="${list.first}?'disabled'">
                    <a th:onclick="'javascript:page(' + ${list.number - 1} + ')'" aria-label='Previous' class="page-link">
                        <span aria-hidden='true'>Previous</span>
                    </a>
                </li>

                <li class="page-item" th:each="page: ${#numbers.sequence(start, end)}" th:classappend="${list.number eq page-1}?'active':''">
                    <a th:onclick="'javascript:page(' + ${page - 1} + ')'" th:inline="text" class="page-link">[[${page}]]</a>
                </li>

                <li class="page-item" th:classappend="${list.last}?'disabled'">
                    <a th:onclick="'javascript:page(' + ${list.number + 1} + ')'" aria-label='Next' class="page-link">
                        <span aria-hidden='true'>Next</span>
                    </a>
                </li>

            </ul>

        </div>
        <button class="btn btn-outline-primary" th:onclick="getCheckboxValue()">삭제</button>
        </div>
    </form>
    <div>

    </div>
</div>

</html>